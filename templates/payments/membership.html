{% extends 'base.html' %}
{% load static %}

{% block title %}Membership Plans — StockPro{% endblock %}

{% block page_content %}
<!-- Hero Header -->
<div class="text-center py-12 px-4">
    <div class="inline-flex items-center gap-2 bg-accent-teal/10 border border-accent-teal/20 text-accent-teal text-xs font-bold px-4 py-1.5 rounded-full mb-6">
        <span class="material-symbols-outlined text-[14px]">stars</span>
        MEMBERSHIP PLANS
    </div>
    <h1 class="text-4xl md:text-5xl font-bold text-text-main tracking-tight mb-4">Choose the plan that<br>fits your goals</h1>
    <p class="text-text-muted text-base max-w-lg mx-auto font-light">Unlock premium research calls, advanced analytics, and expert trading insights.</p>

    <!-- Billing Toggle -->
    <div class="flex items-center justify-center gap-4 mt-10">
        <span class="text-sm font-semibold text-text-main" id="monthlyLabel">Monthly</span>
        <button id="billingToggle" class="relative w-14 h-7 rounded-full bg-gray-200 border border-gray-300 transition-all" onclick="toggleBilling()">
            <div id="toggleDot" class="absolute top-1 left-1 w-5 h-5 rounded-full bg-text-main transition-all duration-300"></div>
        </button>
        <span class="text-sm font-semibold text-text-muted" id="yearlyLabel">
            Yearly
            <span class="text-[10px] ml-1 bg-accent-teal/10 text-accent-teal font-bold px-2 py-0.5 rounded-full">Save 17%</span>
        </span>
    </div>
</div>

<!-- Pricing Cards -->
<div class="max-w-5xl mx-auto pb-20">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
        {% for plan in plans %}
        <div class="relative group">
            {% if plan.plan_type == 'PRO' %}
            <!-- PRO badge -->
            <div class="absolute -top-3 left-1/2 -translate-x-1/2 z-10">
                <span class="bg-gradient-to-r from-accent-gold to-orange-500 text-white text-[10px] font-bold uppercase tracking-wider px-4 py-1 rounded-full">Most Popular</span>
            </div>
            {% endif %}

            <div class="bg-surface border {% if plan.plan_type == 'PRO' %}border-accent-gold/30 ring-1 ring-accent-gold/20{% else %}border-gray-200{% endif %} rounded-2xl p-8 transition-all hover:shadow-soft-hover shadow-soft">
                <!-- Plan Name -->
                <div class="flex items-center gap-3 mb-6">
                    <div class="size-10 rounded-xl {% if plan.plan_type == 'PRO' %}bg-accent-gold/10{% else %}bg-accent-teal/10{% endif %} flex items-center justify-center">
                        <span class="material-symbols-outlined {% if plan.plan_type == 'PRO' %}text-accent-gold{% else %}text-accent-teal{% endif %} text-[20px]">
                            {% if plan.plan_type == 'PRO' %}workspace_premium{% else %}person{% endif %}
                        </span>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-text-main">{{ plan.name }}</h3>
                        <p class="text-xs text-text-muted">{% if plan.plan_type == 'PRO' %}For serious traders{% else %}Get started free{% endif %}</p>
                    </div>
                </div>

                <!-- Price -->
                <div class="mb-8">
                    <div class="price-monthly">
                        <span class="text-4xl font-bold text-text-main">₹{{ plan.price_monthly|floatformat:0 }}</span>
                        <span class="text-text-muted text-sm font-medium">/month</span>
                    </div>
                    <div class="price-yearly" style="display:none;">
                        <span class="text-4xl font-bold text-text-main">₹{{ plan.price_yearly|floatformat:0 }}</span>
                        <span class="text-text-muted text-sm font-medium">/year</span>
                    </div>
                </div>

                <!-- CTA -->
                {% if current_subscription and current_subscription.plan_type == plan.plan_type %}
                <button disabled class="w-full py-3.5 rounded-xl text-sm font-bold bg-accent-teal/10 text-accent-teal border border-accent-teal/20 cursor-not-allowed flex items-center justify-center gap-2 mb-8">
                    <span class="material-symbols-outlined text-[18px]">check_circle</span>
                    Current Plan
                </button>
                {% else %}
                <button onclick="initiatePayment('{{ plan.plan_type }}')" class="w-full py-3.5 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 mb-8 {% if plan.plan_type == 'PRO' %}bg-gradient-to-r from-accent-gold to-orange-500 text-white hover:opacity-90 shadow-lg{% else %}bg-text-main text-white hover:opacity-90{% endif %}">
                    Subscribe Now
                    <span class="material-symbols-outlined text-[18px]">arrow_forward</span>
                </button>
                {% endif %}

                <!-- Features -->
                <div class="border-t border-gray-200 pt-6">
                    <p class="text-[10px] font-bold uppercase tracking-widest text-text-muted mb-4">What's included</p>
                    <ul class="space-y-3">
                        {% for feature in plan.features %}
                        <li class="flex items-start gap-3 text-sm text-text-main">
                            <span class="material-symbols-outlined text-accent-teal text-[18px] mt-0.5 flex-shrink-0">check_circle</span>
                            {{ feature }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Trust Bar -->
    <div class="mt-16 text-center">
        <div class="flex items-center justify-center gap-8 flex-wrap">
            <div class="flex items-center gap-2 text-text-muted text-sm">
                <span class="material-symbols-outlined text-[18px]">lock</span>
                <span>Secure Payments</span>
            </div>
            <div class="flex items-center gap-2 text-text-muted text-sm">
                <span class="material-symbols-outlined text-[18px]">support_agent</span>
                <span>24/7 Support</span>
            </div>
            <div class="flex items-center gap-2 text-text-muted text-sm">
                <span class="material-symbols-outlined text-[18px]">cancel</span>
                <span>Cancel Anytime</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block page_js %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
let isYearly = false;

function toggleBilling() {
    isYearly = !isYearly;
    const dot = document.getElementById('toggleDot');
    const monthlyLabel = document.getElementById('monthlyLabel');
    const yearlyLabel = document.getElementById('yearlyLabel');
    
    dot.style.left = isYearly ? '2rem' : '0.25rem';
    monthlyLabel.classList.toggle('text-text-main', !isYearly);
    monthlyLabel.classList.toggle('text-text-muted', isYearly);
    yearlyLabel.classList.toggle('text-text-main', isYearly);
    yearlyLabel.classList.toggle('text-text-muted', !isYearly);
    
    document.querySelectorAll('.price-monthly').forEach(el => el.style.display = isYearly ? 'none' : 'block');
    document.querySelectorAll('.price-yearly').forEach(el => el.style.display = isYearly ? 'block' : 'none');
}

function initiatePayment(planType) {
    const billingCycle = isYearly ? 'YEARLY' : 'MONTHLY';
    
    fetch('{% url "payments:create_order" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `plan_type=${planType}&billing_cycle=${billingCycle}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        const options = {
            key: data.key,
            amount: data.amount * 100,
            currency: data.currency,
            name: data.name,
            description: data.description,
            order_id: data.order_id,
            prefill: data.prefill,
            theme: { color: '#38B2AC' },
            handler: function(response) {
                verifyPayment(response);
            }
        };
        
        const rzp = new Razorpay(options);
        rzp.open();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to initiate payment');
    });
}

function verifyPayment(response) {
    fetch('{% url "payments:verify_payment" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(response)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            window.location.href = '/';
        } else {
            alert('Payment verification failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Payment verification failed');
    });
}
</script>
{% endblock %}
