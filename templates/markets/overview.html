{% extends 'base.html' %}
{% load static %}

{% block title %}Market Overview ‚Äî StockPro{% endblock %}

{% block page_content %}
<div class="space-y-10">
    <!-- HERO HEADER -->
    <div class="bg-surface rounded-3xl p-8 shadow-soft border border-gray-50 flex flex-col md:flex-row justify-between items-center gap-8">
        <div class="space-y-2 text-center md:text-left">
            <h1 class="text-3xl font-extrabold text-text-main m-0 flex items-center justify-center md:justify-start gap-3">
                <span class="material-symbols-outlined text-accent-blue text-3xl">analytics</span>
                Market Hero
            </h1>
            <p class="text-text-muted text-sm font-medium m-0">Multi-Stockbroker Pro Research & Live Market Data</p>
        </div>
        
        <div class="flex items-center gap-8">
            <div class="text-center">
                <div class="text-2xl font-black text-accent-blue">{{ active_calls|default:"0" }}</div>
                <div class="text-[10px] font-bold text-text-muted uppercase tracking-wider">Active Calls</div>
            </div>
            <div class="h-10 w-px bg-gray-100 italic"></div>
            <div class="text-center">
                <div class="text-2xl font-black text-text-main">{{ total_calls|default:"0" }}</div>
                <div class="text-[10px] font-bold text-text-muted uppercase tracking-wider">Total Calls</div>
            </div>
            <div class="h-10 w-px bg-gray-100 italic"></div>
            <div class="text-center">
                <div class="text-2xl font-black text-green-500">{{ success_rate }}%</div>
                <div class="text-[10px] font-bold text-text-muted uppercase tracking-wider">Success Rate</div>
            </div>
        </div>
    </div>

    <!-- MARKET INDICES -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        {% for idx in market_indices %}
        <div class="bg-surface p-6 rounded-2xl shadow-soft border border-gray-50 hover:border-accent-blue/20 transition-all group overflow-hidden relative">
            <div class="absolute -right-4 -bottom-4 size-20 bg-accent-blue/5 rounded-full blur-2xl group-hover:bg-accent-blue/10 transition-colors"></div>
            <div class="relative z-10">
                <p class="text-[10px] font-bold text-text-muted uppercase tracking-wider mb-2">{{ idx.name }}</p>
                <h3 class="text-xl font-extrabold text-text-main mb-2">‚Çπ{{ idx.price|floatformat:2 }}</h3>
                <div class="flex items-center gap-1.5 text-xs font-bold {% if idx.change >= 0 %}text-green-500{% else %}text-red-500{% endif %}">
                    <span class="material-symbols-outlined text-sm">{% if idx.change >= 0 %}trending_up{% else %}trending_down{% endif %}</span>
                    {{ idx.change|floatformat:2 }} ({{ idx.change_pct|floatformat:2 }}%)
                </div>
            </div>
        </div>
        {% empty %}
        <!-- Defaults if no API data -->
        <div class="bg-surface p-6 rounded-2xl shadow-soft border border-gray-50">
            <p class="text-[10px] font-bold text-text-muted uppercase tracking-wider mb-2">NIFTY 50</p>
            <h3 class="text-xl font-extrabold text-text-main mb-2">‚Çπ22,145.50</h3>
            <div class="flex items-center gap-1.5 text-xs font-bold text-green-500">
                <span class="material-symbols-outlined text-sm">trending_up</span>
                85.30 (0.39%)
            </div>
        </div>
        <!-- ... (more defaults omitted for brevity in thought, but included in content) ... -->
        <div class="bg-surface p-6 rounded-2xl shadow-soft border border-gray-50">
            <p class="text-[10px] font-bold text-text-muted uppercase tracking-wider mb-2">SENSEX</p>
            <h3 class="text-xl font-extrabold text-text-main mb-2">‚Çπ72,980.20</h3>
            <div class="flex items-center gap-1.5 text-xs font-bold text-green-500">
                <span class="material-symbols-outlined text-sm">trending_up</span>
                248.10 (0.34%)
            </div>
        </div>
        <div class="bg-surface p-6 rounded-2xl shadow-soft border border-gray-50">
            <p class="text-[10px] font-bold text-text-muted uppercase tracking-wider mb-2">BANK NIFTY</p>
            <h3 class="text-xl font-extrabold text-text-main mb-2">‚Çπ47,125.80</h3>
            <div class="flex items-center gap-1.5 text-xs font-bold text-red-500">
                <span class="material-symbols-outlined text-sm">trending_down</span>
                -120.50 (-0.26%)
            </div>
        </div>
        <div class="bg-surface p-6 rounded-2xl shadow-soft border border-gray-50">
            <p class="text-[10px] font-bold text-text-muted uppercase tracking-wider mb-2">NIFTY IT</p>
            <h3 class="text-xl font-extrabold text-text-main mb-2">‚Çπ37,450.40</h3>
            <div class="flex items-center gap-1.5 text-xs font-bold text-green-500">
                <span class="material-symbols-outlined text-sm">trending_up</span>
                195.60 (0.52%)
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- MARKET SENTIMENT -->
    <div class="bg-surface px-6 py-4 rounded-2xl shadow-soft border border-gray-50 flex items-center gap-6">
        <span class="text-xs font-bold text-text-muted uppercase tracking-widest whitespace-nowrap">Market Sentiment</span>
        <div class="flex items-center gap-2">
            <span class="text-green-500 font-bold text-xs flex items-center gap-1"><span class="text-lg">üêÇ</span> BUY {{ sentiment.buy_pct }}%</span>
        </div>
        <div class="flex-1 h-2.5 bg-red-100 rounded-full overflow-hidden">
            <div class="h-full bg-green-500 rounded-full transition-all duration-1000" style="width: {{ sentiment.buy_pct }}%"></div>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-red-500 font-bold text-xs flex items-center gap-1">SELL {{ sentiment.sell_pct }}% <span class="text-lg">üêª</span></span>
        </div>
        <span class="text-[10px] font-bold text-text-muted uppercase tracking-wider whitespace-nowrap">({{ sentiment.total }} Active Calls)</span>
    </div>

    <!-- HEATMAP SECTION -->
    <div class="space-y-6">
        <div class="flex items-center justify-between px-1">
            <h2 class="text-lg font-bold text-text-main m-0 flex items-center gap-2">
                <span class="material-symbols-outlined text-orange-500">local_fire_department</span>
                Today Top 10 Gainers & Losers
            </h2>
            <a href="{% url 'dashboard:gainers_losers' %}" class="text-sm font-bold text-accent-blue hover:underline">View Deep Analysis ‚Üí</a>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Gainers -->
            <div class="bg-surface p-6 rounded-2xl shadow-soft border border-gray-50 space-y-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-bold text-green-600 m-0">üìà Top Gainers</h3>
                    <span class="px-2.5 py-1 rounded-full bg-green-50 text-green-600 text-[10px] font-black uppercase tracking-wider italic">Bullish</span>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
                    {% for stock in today_gainers %}
                    <div class="p-3 rounded-xl {% if stock.change_pct >= 2 %}bg-green-600 text-white shadow-lg shadow-green-200{% elif stock.change_pct >= 1 %}bg-green-500 text-white shadow-md shadow-green-100{% else %}bg-green-50 text-green-700{% endif %} flex flex-col items-center justify-center text-center group cursor-pointer hover:scale-105 transition-transform">
                        <span class="text-[10px] font-bold opacity-80 mb-1">{{ stock.symbol }}</span>
                        <span class="text-sm font-black">+{{ stock.change_pct }}%</span>
                        <span class="text-[10px] font-bold opacity-80 mt-1">‚Çπ{{ stock.price }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Losers -->
            <div class="bg-surface p-6 rounded-2xl shadow-soft border border-gray-50 space-y-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-bold text-red-600 m-0">üìâ Top Losers</h3>
                    <span class="px-2.5 py-1 rounded-full bg-red-50 text-red-600 text-[10px] font-black uppercase tracking-wider italic">Bearish</span>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
                    {% for stock in today_losers %}
                    <div class="p-3 rounded-xl {% if stock.change_pct <= -2 %}bg-red-600 text-white shadow-lg shadow-red-200{% elif stock.change_pct <= -1 %}bg-red-500 text-white shadow-md shadow-red-100{% else %}bg-red-50 text-red-700{% endif %} flex flex-col items-center justify-center text-center cursor-pointer hover:scale-105 transition-transform">
                        <span class="text-[10px] font-bold opacity-80 mb-1">{{ stock.symbol }}</span>
                        <span class="text-sm font-black">{{ stock.change_pct }}%</span>
                        <span class="text-[10px] font-bold opacity-80 mt-1">‚Çπ{{ stock.price }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- WEEKLY SECTIONS -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="space-y-4">
            <h2 class="text-lg font-bold text-text-main m-0 px-1 flex items-center gap-2">
                <span class="material-symbols-outlined text-green-500">calendar_month</span>
                Weekly Top Gainers
            </h2>
            <div class="flex gap-4 overflow-x-auto pb-4 hide-scrollbar">
                {% for stock in weekly_gainers %}
                <div class="min-width-[160px] bg-surface p-5 rounded-2xl shadow-soft border border-gray-50 flex flex-col items-center justify-center text-center shrink-0 border-b-2 border-b-green-500">
                    <span class="text-xs font-bold text-text-main mb-2">{{ stock.symbol }}</span>
                    <span class="text-lg font-black text-text-main">‚Çπ{{ stock.price }}</span>
                    <span class="text-sm font-bold text-green-600 mt-1">+{{ stock.change_pct }}%</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="space-y-4">
            <h2 class="text-lg font-bold text-text-main m-0 px-1 flex items-center gap-2">
                <span class="material-symbols-outlined text-red-500">history_toggle_off</span>
                Weekly Top Losers
            </h2>
            <div class="flex gap-4 overflow-x-auto pb-4 hide-scrollbar">
                {% for stock in weekly_losers %}
                <div class="min-width-[160px] bg-surface p-5 rounded-2xl shadow-soft border border-gray-50 flex flex-col items-center justify-center text-center shrink-0 border-b-2 border-b-red-500">
                    <span class="text-xs font-bold text-text-main mb-2">{{ stock.symbol }}</span>
                    <span class="text-lg font-black text-text-main">‚Çπ{{ stock.price }}</span>
                    <span class="text-sm font-bold text-red-600 mt-1">{{ stock.change_pct }}%</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- SNAPSHOT WIDGETS -->
    <div>
        <h2 class="text-lg font-bold text-text-main m-0 px-1 mb-6 flex items-center gap-2">
            <span class="material-symbols-outlined text-accent-teal">grid_view</span>
            Market Snapshot
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Commodities -->
            <div class="bg-surface rounded-2xl shadow-soft border border-gray-50 flex flex-col h-full overflow-hidden">
                <div class="bg-gradient-to-r from-orange-500 to-amber-500 p-4 text-white font-bold text-sm tracking-widest uppercase flex items-center gap-2">
                    <span class="material-symbols-outlined text-xl">oil_barrel</span>
                    Commodities
                </div>
                <div class="flex-1 divide-y divide-gray-50">
                    {% for item in commodities %}
                    <div class="p-4 flex justify-between items-center hover:bg-gray-50 transition-colors">
                        <div>
                            <p class="text-xs font-bold text-text-main m-0">{{ item.icon }} {{ item.name }}</p>
                            <p class="text-[10px] font-bold text-text-muted m-0">{{ item.unit }}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-black text-text-main m-0">{{ item.price|floatformat:2 }}</p>
                            <p class="text-[11px] font-bold {% if item.change_pct >= 0 %}text-green-500{% else %}text-red-500{% endif %} m-0">
                                {% if item.change_pct >= 0 %}+{% endif %}{{ item.change_pct }}%
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- IPOs -->
            <div class="bg-surface rounded-2xl shadow-soft border border-gray-50 flex flex-col h-full overflow-hidden">
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 text-white font-bold text-sm tracking-widest uppercase flex items-center gap-2">
                    <span class="material-symbols-outlined text-xl">corporate_fare</span>
                    Upcoming IPOs
                </div>
                <div class="flex-1 divide-y divide-gray-50">
                    {% for ipo in upcoming_ipos|slice:":4" %}
                    <div class="p-4 flex justify-between items-center hover:bg-gray-50 transition-colors">
                        <div class="space-y-1">
                            <p class="text-xs font-bold text-text-main m-0">{{ ipo.company }}</p>
                            <p class="text-[10px] font-bold text-text-muted m-0">{{ ipo.sector }} ¬∑ {{ ipo.price_band }}</p>
                        </div>
                        <span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider {% if ipo.status == 'OPEN' %}bg-green-50 text-green-600{% elif ipo.status == 'UPCOMING' %}bg-blue-50 text-blue-600{% else %}bg-gray-50 text-gray-500{% endif %}">
                            {{ ipo.status }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- ETFs -->
            <div class="bg-surface rounded-2xl shadow-soft border border-gray-50 flex flex-col h-full overflow-hidden">
                <div class="bg-gradient-to-r from-purple-600 to-fuchsia-600 p-4 text-white font-bold text-sm tracking-widest uppercase flex items-center gap-2">
                    <span class="material-symbols-outlined text-xl">package</span>
                    Popular ETFs
                </div>
                <div class="flex-1 divide-y divide-gray-50">
                    {% for etf in etfs|slice:":5" %}
                    <div class="p-4 flex justify-between items-center hover:bg-gray-50 transition-colors">
                        <div>
                            <p class="text-xs font-bold text-text-main m-0">{{ etf.symbol }}</p>
                            <p class="text-[10px] font-bold text-text-muted m-0">{{ etf.category }}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-black text-text-main m-0">‚Çπ{{ etf.price }}</p>
                            <p class="text-[11px] font-bold {% if etf.change_pct >= 0 %}text-green-500{% else %}text-red-500{% endif %} m-0">
                                {% if etf.change_pct >= 0 %}+{% endif %}{{ etf.change_pct }}%
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- QUICK EXPLORE -->
    <div class="space-y-6">
        <h2 class="text-lg font-bold text-text-main m-0 px-1 flex items-center gap-2">
            <span class="material-symbols-outlined text-orange-500">rocket_launch</span>
            Explore More
        </h2>
        
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-7 gap-4">
            <a href="{% url 'dashboard:sip' %}" class="bg-white p-4 rounded-xl shadow-soft border border-gray-50 hover:bg-teal-50 group transition-colors text-center no-underline">
                <span class="block text-2xl mb-2">üí∞</span>
                <span class="block text-xs font-bold text-text-main uppercase tracking-widest">SIP</span>
                <span class="block text-[10px] font-bold text-text-muted mt-1 uppercase group-hover:text-teal-600">Growth</span>
            </a>
            <a href="{% url 'dashboard:mutual_funds' %}" class="bg-white p-4 rounded-xl shadow-soft border border-gray-50 hover:bg-blue-50 group transition-colors text-center no-underline">
                <span class="block text-2xl mb-2">üìà</span>
                <span class="block text-xs font-bold text-text-main uppercase tracking-widest">Mutual Funds</span>
                <span class="block text-[10px] font-bold text-text-muted mt-1 uppercase group-hover:text-blue-600">Top Funds</span>
            </a>
            <a href="{% url 'dashboard:etf' %}" class="bg-white p-4 rounded-xl shadow-soft border border-gray-50 hover:bg-purple-50 group transition-colors text-center no-underline">
                <span class="block text-2xl mb-2">üì¶</span>
                <span class="block text-xs font-bold text-text-main uppercase tracking-widest">ETFs</span>
                <span class="block text-[10px] font-bold text-text-muted mt-1 uppercase group-hover:text-purple-600">Trading</span>
            </a>
            <a href="{% url 'dashboard:bonds' %}" class="bg-white p-4 rounded-xl shadow-soft border border-gray-50 hover:bg-amber-50 group transition-colors text-center no-underline">
                <span class="block text-2xl mb-2">üèõÔ∏è</span>
                <span class="block text-xs font-bold text-text-main uppercase tracking-widest">Bonds</span>
                <span class="block text-[10px] font-bold text-text-muted mt-1 uppercase group-hover:text-amber-800">Fixed Income</span>
            </a>
            <a href="{% url 'dashboard:commodity' %}" class="bg-white p-4 rounded-xl shadow-soft border border-gray-50 hover:bg-orange-50 group transition-colors text-center no-underline">
                <span class="block text-2xl mb-2">üõ¢Ô∏è</span>
                <span class="block text-xs font-bold text-text-main uppercase tracking-widest">Commodities</span>
                <span class="block text-[10px] font-bold text-text-muted mt-1 uppercase group-hover:text-orange-600">Gold & Silver</span>
            </a>
            <a href="{% url 'dashboard:liquidity' %}" class="bg-white p-4 rounded-xl shadow-soft border border-gray-50 hover:bg-slate-50 group transition-colors text-center no-underline">
                <span class="block text-2xl mb-2">üíß</span>
                <span class="block text-xs font-bold text-text-main uppercase tracking-widest">Liquidity</span>
                <span class="block text-[10px] font-bold text-text-muted mt-1 uppercase group-hover:text-slate-600">Money Market</span>
            </a>
            <a href="{% url 'dashboard:trades_dashboard' %}" class="bg-white p-4 rounded-xl shadow-soft border border-gray-50 hover:bg-indigo-50 group transition-colors text-center no-underline">
                <span class="block text-2xl mb-2">üìã</span>
                <span class="block text-xs font-bold text-text-main uppercase tracking-widest">Trades</span>
                <span class="block text-[10px] font-bold text-text-muted mt-1 uppercase group-hover:text-indigo-600">All Calls</span>
            </a>
        </div>
    </div>
</div>
{% endblock %}
