{% extends 'base.html' %}
{% load static %}

{% block page_css %}
<link rel="stylesheet" href="{% static 'css/market_hero.css' %}">
{% endblock page_css %}

{% block page_content %}
<div class="market-hero">
  <div class="hero-container">

    <!-- â•â•â• Hero Banner â•â•â• -->
    <div class="hero-banner">
      <div>
        <div class="hero-title">ğŸ“Š Market Hero</div>
        <div class="hero-subtitle">Multi-Stockbroker Pro Research & Live Market Data</div>
      </div>
      <div class="hero-stats">
        <div class="stat-item">
          <div class="stat-value">{{ active_calls|default:"0" }}</div>
          <div class="stat-label">Active Calls</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ total_calls|default:"0" }}</div>
          <div class="stat-label">Total Calls</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ success_rate }}%</div>
          <div class="stat-label">Success Rate</div>
        </div>
      </div>
    </div>

    <!-- â•â•â• Market Indices Strip â•â•â• -->
    <div class="index-strip">
      {% for idx in market_indices %}
      <div class="index-card">
        <div class="index-name">{{ idx.name }}</div>
        <div class="index-price">â‚¹{{ idx.price|floatformat:2 }}</div>
        <div class="index-change {% if idx.change >= 0 %}positive{% else %}negative{% endif %}">
          {% if idx.change >= 0 %}â–²{% else %}â–¼{% endif %}
          {{ idx.change|floatformat:2 }} ({{ idx.change_pct|floatformat:2 }}%)
        </div>
      </div>
      {% empty %}
      <div class="index-card">
        <div class="index-name">NIFTY 50</div>
        <div class="index-price">â‚¹22,145.50</div>
        <div class="index-change positive">â–² 85.30 (0.39%)</div>
      </div>
      <div class="index-card">
        <div class="index-name">SENSEX</div>
        <div class="index-price">â‚¹72,980.20</div>
        <div class="index-change positive">â–² 248.10 (0.34%)</div>
      </div>
      <div class="index-card">
        <div class="index-name">BANK NIFTY</div>
        <div class="index-price">â‚¹47,125.80</div>
        <div class="index-change negative">â–¼ 120.50 (-0.26%)</div>
      </div>
      <div class="index-card">
        <div class="index-name">NIFTY IT</div>
        <div class="index-price">â‚¹37,450.40</div>
        <div class="index-change positive">â–² 195.60 (0.52%)</div>
      </div>
      {% endfor %}
    </div>

    <!-- â•â•â• Market Sentiment â•â•â• -->
    <div class="sentiment-bar">
      <span class="sentiment-label">Market Sentiment</span>
      <span class="sentiment-label text-gain">ğŸ‚ Buy {{ sentiment.buy_pct }}%</span>
      <div class="sentiment-track">
        <div class="sentiment-fill" style="width: {{ sentiment.buy_pct }}%"></div>
      </div>
      <span class="sentiment-label text-loss">ğŸ» Sell {{ sentiment.sell_pct }}%</span>
      <span class="sentiment-text">({{ sentiment.total }} Active Calls)</span>
    </div>

    <!-- â•â•â• Today Top 10 Gainers / Losers Heatmap â•â•â• -->
    <div class="section-header-hero">
      <div class="section-title-hero">
        <span class="icon">ğŸ”¥</span> Today Top 10 Gainers & Losers
        <span class="live-dot"></span>
      </div>
      <a href="{% url 'dashboard:markets' %}" class="view-all-link">View All â†’</a>
    </div>

    <div class="heatmap-section">
      <!-- Gainers -->
      <div class="heatmap-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <span style="font-weight: 700; color: var(--accent-green); font-size: 15px;">ğŸ“ˆ Top Gainers</span>
          <span class="ipo-status ipo-open">Bullish</span>
        </div>
        <div class="heatmap-grid">
          {% for stock in today_gainers %}
          <div class="stock-tile {% if stock.change_pct >= 2 %}gain-1{% elif stock.change_pct >= 1 %}gain-2{% else %}gain-3{% endif %}">
            <span class="tile-symbol">{{ stock.symbol }}</span>
            <span class="tile-change">+{{ stock.change_pct }}%</span>
            <span class="tile-price">â‚¹{{ stock.price }}</span>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Losers -->
      <div class="heatmap-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <span style="font-weight: 700; color: var(--accent-red); font-size: 15px;">ğŸ“‰ Top Losers</span>
          <span class="ipo-status" style="background: rgba(255,82,82,0.15); color: var(--accent-red);">Bearish</span>
        </div>
        <div class="heatmap-grid">
          {% for stock in today_losers %}
          <div class="stock-tile {% if stock.change_pct <= -2 %}loss-1{% elif stock.change_pct <= -1 %}loss-2{% else %}loss-3{% endif %}">
            <span class="tile-symbol">{{ stock.symbol }}</span>
            <span class="tile-change">{{ stock.change_pct }}%</span>
            <span class="tile-price">â‚¹{{ stock.price }}</span>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- â•â•â• Weekly Top Gainers â•â•â• -->
    <div class="weekly-section">
      <div class="section-header-hero">
        <div class="section-title-hero">
          <span class="icon">ğŸ“Š</span> Weekly Top Gainers
        </div>
      </div>
      <div class="weekly-scroll">
        {% for stock in weekly_gainers %}
        <div class="weekly-card">
          <div class="weekly-symbol">{{ stock.symbol }}</div>
          <div class="weekly-price">â‚¹{{ stock.price }}</div>
          <div class="weekly-change text-gain">+{{ stock.change_pct }}%</div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- â•â•â• Weekly Top Losers â•â•â• -->
    <div class="weekly-section">
      <div class="section-header-hero">
        <div class="section-title-hero">
          <span class="icon">ğŸ“‰</span> Weekly Top Losers
        </div>
      </div>
      <div class="weekly-scroll">
        {% for stock in weekly_losers %}
        <div class="weekly-card">
          <div class="weekly-symbol">{{ stock.symbol }}</div>
          <div class="weekly-price">â‚¹{{ stock.price }}</div>
          <div class="weekly-change text-loss">{{ stock.change_pct }}%</div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- â•â•â• Commodity / IPO / ETF Widgets Row â•â•â• -->
    <div class="section-header-hero">
      <div class="section-title-hero">
        <span class="icon">ğŸ’¹</span> Market Snapshot
      </div>
    </div>

    <div class="widgets-row">
      <!-- Commodity Widget -->
      <div class="widget-card-hero">
        <div class="widget-header-hero header-commodity">ğŸ›¢ï¸ Commodities</div>
        <ul class="widget-list-hero">
          {% for item in commodities %}
          <li class="widget-item-hero">
            <div class="item-info">
              <div class="item-name-hero">{{ item.icon }} {{ item.name }}</div>
              <div class="item-sub-hero">{{ item.unit }}</div>
            </div>
            <div class="item-value-hero">
              <div class="item-price">{{ item.price|floatformat:2 }}</div>
              <div class="item-change-hero {% if item.change_pct >= 0 %}text-gain{% else %}text-loss{% endif %}">
                {% if item.change_pct >= 0 %}+{% endif %}{{ item.change_pct }}%
              </div>
            </div>
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- IPO Widget -->
      <div class="widget-card-hero">
        <div class="widget-header-hero header-ipo">ğŸ¢ Upcoming IPOs</div>
        <ul class="widget-list-hero">
          {% for ipo in upcoming_ipos|slice:":4" %}
          <li class="widget-item-hero">
            <div class="item-info">
              <div class="item-name-hero">{{ ipo.company }}</div>
              <div class="item-sub-hero">{{ ipo.sector }} Â· {{ ipo.price_band }}</div>
            </div>
            <div class="item-value-hero">
              <span class="ipo-status {% if ipo.status == 'OPEN' %}ipo-open{% elif ipo.status == 'UPCOMING' %}ipo-upcoming{% else %}ipo-closed{% endif %}">
                {{ ipo.status }}
              </span>
            </div>
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- ETF Widget -->
      <div class="widget-card-hero">
        <div class="widget-header-hero header-etf">ğŸ“¦ Popular ETFs</div>
        <ul class="widget-list-hero">
          {% for etf in etfs|slice:":5" %}
          <li class="widget-item-hero">
            <div class="item-info">
              <div class="item-name-hero">{{ etf.symbol }}</div>
              <div class="item-sub-hero">{{ etf.category }}</div>
            </div>
            <div class="item-value-hero">
              <div class="item-price">â‚¹{{ etf.price }}</div>
              <div class="item-change-hero {% if etf.change_pct >= 0 %}text-gain{% else %}text-loss{% endif %}">
                {% if etf.change_pct >= 0 %}+{% endif %}{{ etf.change_pct }}%
              </div>
            </div>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- â•â•â• SIP / Mutual Funds / Bonds Row â•â•â• -->
    <div class="widgets-row">
      <!-- SIP Widget -->
      <div class="widget-card-hero">
        <div class="widget-header-hero header-sip">ğŸ’° Top SIP Funds</div>
        <ul class="widget-list-hero">
          {% for sip in sip_funds|slice:":4" %}
          <li class="widget-item-hero">
            <div class="item-info">
              <div class="item-name-hero">{{ sip.name }}</div>
              <div class="item-sub-hero">{{ sip.category }} Â· Min â‚¹{{ sip.min_sip }}</div>
            </div>
            <div class="item-value-hero">
              <div class="item-change-hero text-gain">{{ sip.returns_1y }}% <span style="font-size:10px; color: var(--text-muted);">1Y</span></div>
            </div>
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- Mutual Funds Widget -->
      <div class="widget-card-hero">
        <div class="widget-header-hero header-mf">ğŸ“ˆ Mutual Funds</div>
        <ul class="widget-list-hero">
          {% for mf in mutual_funds|slice:":4" %}
          <li class="widget-item-hero">
            <div class="item-info">
              <div class="item-name-hero">{{ mf.name }}</div>
              <div class="item-sub-hero">{{ mf.category }} Â· AUM {{ mf.aum }}</div>
            </div>
            <div class="item-value-hero">
              <div class="item-change-hero text-gain">{{ mf.returns_1y }}% <span style="font-size:10px; color: var(--text-muted);">1Y</span></div>
              <div class="star-rating">{% for i in "12345" %}{% if forloop.counter <= mf.rating %}â˜…{% else %}â˜†{% endif %}{% endfor %}</div>
            </div>
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- Bonds Widget -->
      <div class="widget-card-hero">
        <div class="widget-header-hero header-bonds">ğŸ›ï¸ Bonds</div>
        <ul class="widget-list-hero">
          {% for bond in bonds|slice:":4" %}
          <li class="widget-item-hero">
            <div class="item-info">
              <div class="item-name-hero">{{ bond.name }}</div>
              <div class="item-sub-hero">{{ bond.type }} Â· {{ bond.rating }}</div>
            </div>
            <div class="item-value-hero">
              <div class="item-price">{{ bond.yield_pct }}%</div>
              <div class="item-sub-hero">Yield Â· {{ bond.maturity }}</div>
            </div>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- â•â•â• Liquidity / Recently Listed Row â•â•â• -->
    <div class="widgets-row">
      <!-- Liquidity Widget -->
      <div class="widget-card-hero">
        <div class="widget-header-hero header-liquidity">ğŸ’§ Money Market & Liquidity</div>
        <ul class="widget-list-hero">
          {% for rate in liquidity|slice:":5" %}
          <li class="widget-item-hero">
            <div class="item-info">
              <div class="item-name-hero">{{ rate.name }}</div>
              <div class="item-sub-hero">{{ rate.description }}</div>
            </div>
            <div class="item-value-hero">
              <div class="item-price">{{ rate.rate }}%</div>
              <div class="item-change-hero {% if rate.change > 0 %}text-gain{% elif rate.change < 0 %}text-loss{% else %}{% endif %}">
                {% if rate.change > 0 %}+{% endif %}{% if rate.change != 0 %}{{ rate.change }}%{% else %}â€”{% endif %}
              </div>
            </div>
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- Recently Listed IPOs -->
      <div class="widget-card-hero">
        <div class="widget-header-hero header-ipo">ğŸ†• Recently Listed</div>
        <ul class="widget-list-hero">
          {% for ipo in recently_listed %}
          <li class="widget-item-hero">
            <div class="item-info">
              <div class="item-name-hero">{{ ipo.company }}</div>
              <div class="item-sub-hero">{{ ipo.sector }} Â· Issue â‚¹{{ ipo.issue_price }}</div>
            </div>
            <div class="item-value-hero">
              <div class="item-price">â‚¹{{ ipo.current_price }}</div>
              <div class="item-change-hero {% if ipo.return_pct >= 0 %}text-gain{% else %}text-loss{% endif %}">
                {% if ipo.return_pct >= 0 %}+{% endif %}{{ ipo.return_pct }}%
              </div>
            </div>
          </li>
          {% endfor %}
        </ul>
      </div>

      <!-- Top Brokers Widget -->
      <div class="widget-card-hero">
        <div class="widget-header-hero" style="background: linear-gradient(135deg, #00695c, #00897b);">ğŸ† Top Performing Brokers</div>
        <ul class="widget-list-hero">
          {% for broker in top_brokers %}
          <li class="widget-item-hero">
            <div class="item-info">
              <div class="item-name-hero">{{ broker.name }}</div>
              <div class="item-sub-hero">{{ broker.total_calls }} calls published</div>
            </div>
            <div class="item-value-hero">
              <div class="item-price text-gain">{{ broker.overall_accuracy|default:"N/A" }}%</div>
              <div class="item-sub-hero">accuracy</div>
            </div>
          </li>
          {% empty %}
          <li class="widget-item-hero">
            <div class="item-info">
              <div class="item-name-hero">No brokers yet</div>
              <div class="item-sub-hero">Add brokers from admin panel</div>
            </div>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- â•â•â• Quick Navigation â•â•â• -->
    <div class="section-header-hero" style="margin-top: 20px;">
      <div class="section-title-hero">
        <span class="icon">ğŸš€</span> Explore More
      </div>
    </div>

    <div class="index-strip" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
      <a href="{% url 'dashboard:sip' %}" class="index-card" style="text-decoration: none; background: linear-gradient(135deg, rgba(0,105,92,0.3), rgba(0,137,123,0.1));">
        <div class="index-name">ğŸ’° SIP</div>
        <div style="color: var(--text-secondary); font-size: 12px;">Systematic Plans</div>
      </a>
      <a href="{% url 'dashboard:mutual_funds' %}" class="index-card" style="text-decoration: none; background: linear-gradient(135deg, rgba(40,53,147,0.3), rgba(57,73,171,0.1));">
        <div class="index-name">ğŸ“ˆ Mutual Funds</div>
        <div style="color: var(--text-secondary); font-size: 12px;">Top Performers</div>
      </a>
      <a href="{% url 'dashboard:etf' %}" class="index-card" style="text-decoration: none; background: linear-gradient(135deg, rgba(106,27,154,0.3), rgba(123,31,162,0.1));">
        <div class="index-name">ğŸ“¦ ETFs</div>
        <div style="color: var(--text-secondary); font-size: 12px;">Exchange Traded</div>
      </a>
      <a href="{% url 'dashboard:bonds' %}" class="index-card" style="text-decoration: none; background: linear-gradient(135deg, rgba(78,52,46,0.3), rgba(93,64,55,0.1));">
        <div class="index-name">ğŸ›ï¸ Bonds</div>
        <div style="color: var(--text-secondary); font-size: 12px;">Fixed Income</div>
      </a>
      <a href="{% url 'dashboard:commodity' %}" class="index-card" style="text-decoration: none; background: linear-gradient(135deg, rgba(255,143,0,0.3), rgba(245,124,0,0.1));">
        <div class="index-name">ğŸ›¢ï¸ Commodities</div>
        <div style="color: var(--text-secondary); font-size: 12px;">Gold, Oil, More</div>
      </a>
      <a href="{% url 'dashboard:liquidity' %}" class="index-card" style="text-decoration: none; background: linear-gradient(135deg, rgba(55,71,79,0.3), rgba(69,90,100,0.1));">
        <div class="index-name">ğŸ’§ Liquidity</div>
        <div style="color: var(--text-secondary); font-size: 12px;">Money Market</div>
      </a>
      <a href="{% url 'dashboard:trades_dashboard' %}" class="index-card" style="text-decoration: none; background: linear-gradient(135deg, rgba(68,138,255,0.3), rgba(68,138,255,0.1));">
        <div class="index-name">ğŸ“‹ Trades</div>
        <div style="color: var(--text-secondary); font-size: 12px;">All Categories</div>
      </a>
    </div>

  </div>
</div>
{% endblock %}
