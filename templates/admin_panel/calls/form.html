{% extends 'admin_panel/base.html' %}

{% block title %}
    {% if form.instance.pk %}Edit Call{% else %}New Call{% endif %}
{% endblock %}

{% block extra_css %}
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "bg-dark": "#0b0f17",
                    "surface-dark": "#131825",
                    "border-dark": "#1e2433",
                    "text-secondary": "#94a3b8",
                },
                fontFamily: {
                    display: ["Manrope", "sans-serif"],
                },
            },
        },
    }
</script>
<style>
    body, .admin-layout { background: #0b0f17 !important; font-family: 'Manrope', sans-serif; }
    .admin-main { background: #0b0f17 !important; }
    .admin-container { max-width: 100% !important; }
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
    .minimal-input {
        border: none;
        border-bottom: 1px solid #334155;
        border-radius: 0;
        padding: 0.75rem 0;
        background: transparent;
        transition: border-color 0.2s;
        font-family: 'Manrope', sans-serif;
        color: #e2e8f0;
        font-size: 1rem;
        width: 100%;
    }
    .minimal-input:focus {
        border-bottom: 1px solid #fff;
        box-shadow: none;
        outline: none;
    }
    /* Override Django form widget styles */
    select.minimal-input { appearance: none; cursor: pointer; }
    textarea.minimal-input { border: 0; border-radius: 8px; padding: 1.5rem; resize: vertical; min-height: 200px; }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    /* Make Django-rendered form fields look like minimal inputs */
    .form-field-wrap input,
    .form-field-wrap select,
    .form-field-wrap textarea {
        border: none;
        border-bottom: 1px solid #334155;
        border-radius: 0;
        padding: 0.75rem 0;
        background: transparent !important;
        color: #e2e8f0 !important;
        font-family: 'Manrope', sans-serif;
        font-size: 1rem;
        width: 100%;
        transition: border-color 0.2s;
    }
    .form-field-wrap input:focus,
    .form-field-wrap select:focus {
        border-bottom: 1px solid #fff;
        box-shadow: none;
        outline: none;
    }
    .form-field-wrap textarea {
        border: 0;
        border-radius: 12px;
        padding: 1.5rem;
        background: rgba(255,255,255,0.03) !important;
        min-height: 200px;
        resize: vertical;
        line-height: 1.7;
    }
    .form-field-wrap textarea:focus {
        outline: none;
        box-shadow: none;
        ring: 1px solid #fff;
    }
    .form-field-wrap select { appearance: none; cursor: pointer; }
    .form-field-wrap option { background: #131825; color: #e2e8f0; }
</style>
{% endblock %}

{% block content %}
<div class="font-display text-slate-100 antialiased">
    <!-- Breadcrumb Header -->
    <header class="flex items-center justify-between mb-10">
        <div class="flex items-center gap-2 text-sm">
            <a class="text-text-secondary hover:text-white transition-colors no-underline" href="{% url 'admin_panel:calls_list' %}">Calls</a>
            <span class="text-text-secondary">/</span>
            <span class="text-white font-medium">{% if form.instance.pk %}Edit{% else %}New Entry{% endif %}</span>
        </div>
        <div class="flex gap-4">
            <a href="{% url 'admin_panel:calls_list' %}" class="text-sm font-medium text-text-secondary hover:text-white transition-colors no-underline">Discard</a>
            <button type="submit" form="callForm" class="bg-white text-black px-6 py-2 text-sm font-medium rounded-lg hover:opacity-90 transition-opacity flex items-center gap-2">
                <span>{% if form.instance.pk %}Update{% else %}Publish{% endif %}</span>
                <span class="material-symbols-outlined text-[16px]">arrow_forward</span>
            </button>
        </div>
    </header>

    <div class="max-w-4xl mx-auto">
        <!-- Title -->
        <div class="mb-12">
            <h1 class="text-4xl font-light text-white mb-2 tracking-tight">{% if form.instance.pk %}Edit Research Call{% else %}New Research Call{% endif %}</h1>
            <p class="text-text-secondary font-light">{% if form.instance.pk %}Updating trade recommendation.{% else %}Drafting a new trade recommendation.{% endif %}</p>
        </div>

        <form method="post" id="callForm" class="space-y-16">
            {% csrf_token %}

            {% if form.non_field_errors %}
            <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-4 text-red-400 text-sm">
                {% for error in form.non_field_errors %}
                    {{ error }}<br>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Section 1: Ticker & Type -->
            <section>
                <div class="grid grid-cols-12 gap-x-8 gap-y-8">
                    <div class="col-span-8 form-field-wrap">
                        <label class="block text-[10px] uppercase tracking-widest font-bold text-text-secondary mb-1">Ticker Symbol</label>
                        {{ form.symbol }}
                        {% if form.symbol.errors %}<span class="text-red-400 text-xs mt-1 block">{{ form.symbol.errors.0 }}</span>{% endif %}
                    </div>
                    <div class="col-span-4 form-field-wrap">
                        <label class="block text-[10px] uppercase tracking-widest font-bold text-text-secondary mb-3">Exchange</label>
                        {{ form.exchange }}
                        {% if form.exchange.errors %}<span class="text-red-400 text-xs mt-1 block">{{ form.exchange.errors.0 }}</span>{% endif %}
                    </div>
                    <div class="col-span-6 form-field-wrap">
                        <label class="block text-[10px] uppercase tracking-widest font-bold text-text-secondary mb-1">Instrument Type</label>
                        {{ form.instrument_type }}
                        {% if form.instrument_type.errors %}<span class="text-red-400 text-xs mt-1 block">{{ form.instrument_type.errors.0 }}</span>{% endif %}
                    </div>
                    <div class="col-span-6 form-field-wrap">
                        <label class="block text-[10px] uppercase tracking-widest font-bold text-text-secondary mb-1">Time Horizon</label>
                        {{ form.call_type }}
                        {% if form.call_type.errors %}<span class="text-red-400 text-xs mt-1 block">{{ form.call_type.errors.0 }}</span>{% endif %}
                    </div>
                    <div class="col-span-6 form-field-wrap" data-show-for="equity">
                        <label class="block text-[10px] uppercase tracking-widest font-bold text-text-secondary mb-1">Company Name</label>
                        {{ form.company_name }}
                    </div>
                    <div class="col-span-6 form-field-wrap" data-show-for="equity">
                        <label class="block text-[10px] uppercase tracking-widest font-bold text-text-secondary mb-1">Sector</label>
                        {{ form.sector }}
                    </div>
                    <div class="col-span-4 form-field-wrap">
                        <label class="block text-[10px] uppercase tracking-widest font-bold text-text-secondary mb-1">Status</label>
                        {{ form.status }}
                        {% if form.status.errors %}<span class="text-red-400 text-xs mt-1 block">{{ form.status.errors.0 }}</span>{% endif %}
                    </div>
                </div>
            </section>

            <!-- Section 2: Recommendation & Prices -->
            <section>
                <div class="grid grid-cols-12 gap-x-8 gap-y-10">
                    <!-- Action (BUY/SELL) -->
                    <div class="col-span-12">
                        <label class="block text-[10px] uppercase tracking-widest font-bold text-text-secondary mb-4">Recommendation</label>
                        <div class="form-field-wrap">
                            {{ form.action }}
                        </div>
                        {% if form.action.errors %}<span class="text-red-400 text-xs mt-1 block">{{ form.action.errors.0 }}</span>{% endif %}
                    </div>

                    <!-- Entry Price -->
                    <div class="col-span-4 form-field-wrap">
                        <label class="block text-[10px] uppercase tracking-widest font-bold text-text-secondary mb-1" id="entryLabel">Entry Price</label>
                        {{ form.entry_price }}
                        {% if form.entry_price.errors %}<span class="text-red-400 text-xs mt-1 block">{{ form.entry_price.errors.0 }}</span>{% endif %}
                    </div>

                    <!-- Stop Loss -->
                    <div class="col-span-4 form-field-wrap">
                        <label class="block text-[10px] uppercase tracking-widest font-bold text-text-secondary mb-1" id="stoplossLabel">Stop Loss</label>
                        {{ form.stop_loss }}
                        {% if form.stop_loss.errors %}<span class="text-red-400 text-xs mt-1 block">{{ form.stop_loss.errors.0 }}</span>{% endif %}
                    </div>

                    <div class="col-span-4"></div>

                    <!-- Targets -->
                    <div class="col-span-12">
                        <label class="block text-[10px] uppercase tracking-widest font-bold text-text-secondary mb-1">Targets</label>
                        <div class="grid grid-cols-3 gap-8">
                            <div class="relative form-field-wrap">
                                <span class="absolute left-0 top-3 text-emerald-500 text-xs font-bold">T1</span>
                                <div class="pl-8">{{ form.target_1 }}</div>
                                {% if form.target_1.errors %}<span class="text-red-400 text-xs mt-1 block">{{ form.target_1.errors.0 }}</span>{% endif %}
                            </div>
                            <div class="relative form-field-wrap" data-show-for="medium-long">
                                <span class="absolute left-0 top-3 text-emerald-500 text-xs font-bold opacity-70">T2</span>
                                <div class="pl-8">{{ form.target_2 }}</div>
                            </div>
                            <div class="relative form-field-wrap" data-show-for="long">
                                <span class="absolute left-0 top-3 text-emerald-500 text-xs font-bold opacity-50">T3</span>
                                <div class="pl-8">{{ form.target_3 }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Timeframe -->
                    <div class="col-span-4 form-field-wrap">
                        <label class="block text-[10px] uppercase tracking-widest font-bold text-text-secondary mb-1">Timeframe (Days)</label>
                        {{ form.timeframe_days }}
                        {% if form.timeframe_days.errors %}<span class="text-red-400 text-xs mt-1 block">{{ form.timeframe_days.errors.0 }}</span>{% endif %}
                    </div>
                </div>
            </section>

            <!-- Section 3: Broker -->
            <section>
                <div class="grid grid-cols-12 gap-x-8">
                    <div class="col-span-6 form-field-wrap">
                        <label class="block text-[10px] uppercase tracking-widest font-bold text-text-secondary mb-1">Broker</label>
                        {{ form.broker }}
                        {% if form.broker.errors %}<span class="text-red-400 text-xs mt-1 block">{{ form.broker.errors.0 }}</span>{% endif %}
                    </div>
                </div>
            </section>

            <!-- Section 4: Rationale -->
            <section class="pt-4">
                <div class="flex justify-between items-end mb-4">
                    <label class="block text-[10px] uppercase tracking-widest font-bold text-text-secondary">Rationale & Analysis</label>
                </div>
                <div class="form-field-wrap">
                    {{ form.rationale }}
                    {% if form.rationale.errors %}<span class="text-red-400 text-xs mt-1 block">{{ form.rationale.errors.0 }}</span>{% endif %}
                </div>
            </section>

            <!-- Bottom Submit (mobile) -->
            <section class="border-t border-border-dark pt-8 flex justify-end gap-4 lg:hidden">
                <a href="{% url 'admin_panel:calls_list' %}" class="text-sm font-medium text-text-secondary hover:text-white transition-colors no-underline px-6 py-2">Cancel</a>
                <button type="submit" class="bg-white text-black px-6 py-2 text-sm font-medium rounded-lg hover:opacity-90 transition-opacity flex items-center gap-2">
                    <span>{% if form.instance.pk %}Update{% else %}Publish{% endif %}</span>
                    <span class="material-symbols-outlined text-[16px]">arrow_forward</span>
                </button>
            </section>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const callTypeField = document.querySelector('[name="call_type"]');
    const instrumentTypeField = document.querySelector('[name="instrument_type"]');
    const entryLabel = document.getElementById('entryLabel');
    const stoplossLabel = document.getElementById('stoplossLabel');

    function updateFieldVisibility() {
        const callType = callTypeField ? callTypeField.value : '';
        const instrumentType = instrumentTypeField ? instrumentTypeField.value : '';

        // Reset labels
        if (entryLabel) entryLabel.textContent = 'Entry Price';
        if (stoplossLabel) stoplossLabel.textContent = 'Stop Loss';

        // Hide all conditional sections
        document.querySelectorAll('[data-show-for]').forEach(el => {
            el.style.display = 'none';
            el.style.opacity = '0';
        });

        // Instrument-specific labels
        if (instrumentType === 'OPTIONS') {
            if (entryLabel) entryLabel.textContent = 'Entry Premium';
            if (stoplossLabel) stoplossLabel.textContent = 'Stop Loss Premium';
        }

        // Equity fields
        if (instrumentType === 'EQUITY') {
            document.querySelectorAll('[data-show-for="equity"]').forEach(el => {
                el.style.display = '';
                setTimeout(() => el.style.opacity = '1', 10);
            });
        }

        // Medium/Long term targets
        if (callType === 'MEDIUM_TERM' || callType === 'LONG_TERM') {
            document.querySelectorAll('[data-show-for="medium-long"]').forEach(el => {
                el.style.display = '';
                setTimeout(() => el.style.opacity = '1', 10);
            });
        }

        if (callType === 'LONG_TERM') {
            document.querySelectorAll('[data-show-for="long"]').forEach(el => {
                el.style.display = '';
                setTimeout(() => el.style.opacity = '1', 10);
            });
        }
    }

    if (callTypeField) callTypeField.addEventListener('change', updateFieldVisibility);
    if (instrumentTypeField) instrumentTypeField.addEventListener('change', updateFieldVisibility);
    updateFieldVisibility();
});
</script>
{% endblock %}
