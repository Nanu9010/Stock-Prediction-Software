{% extends 'base.html' %}
{% load static %}

{% block title %}Customer Dashboard - Stock Research Platform{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>Welcome, {{ user.get_full_name }}</h1>
        <p class="text-secondary">Your personalized stock research dashboard</p>
    </div>

    <!-- Quick Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-content">
                <h3>{{ active_items.count }}</h3>
                <p>Active Positions</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üí∞</div>
            <div class="stat-content">
                <h3>‚Çπ{{ portfolio.total_value|default:"0" }}</h3>
                <p>Portfolio Value</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">üìà</div>
            <div class="stat-content">
                <h3>{{ today_calls.count }}</h3>
                <p>Today's Calls</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">‚≠ê</div>
            <div class="stat-content">
                <h3>{{ top_brokers.count }}</h3>
                <p>Top Brokers</p>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="dashboard-grid">
        <!-- Today's Calls -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2>Today's Research Calls</h2>
                <a href="{% url 'research_calls:live_calls' %}" class="btn btn-sm btn-outline">View All</a>
            </div>
            <div class="calls-list trade-cards-grid">
                {% for call in today_calls %}
                <div class="pro-trade-card">
                    <div class="pro-card-header">
                        <span class="posted-date">Posted: {{ call.published_at|date:"h:i A" }}</span>
                        <span class="duration-badge">
                            {{ call.get_call_type_display }}
                        </span>
                    </div>

                    <div class="pro-banner">
                        Available with all PRO plans
                    </div>

                    <div class="pro-visual-container">
                        <div class="potential-badge">
                            Potential left : {{ call.expected_return_percentage|floatformat:2 }} %
                        </div>
                        
                        <div class="card-actions-row">
                            <a href="{% url 'research_calls:call_detail' call.id %}" class="btn-subscribe-lock">
                                View Trade
                            </a>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="empty-state">
                    <p>No research calls published today</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Portfolio Summary -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2>My Portfolio</h2>
                <a href="{% url 'portfolios:portfolio' %}" class="btn btn-sm btn-outline">View Details</a>
            </div>
            <div class="portfolio-summary">
                {% for item in active_items %}
                <div class="portfolio-item">
                    <div class="item-header">
                        <h4>{{ item.research_call.symbol }}</h4>
                        <span class="badge badge-{{ item.status|lower }}">{{ item.status }}</span>
                    </div>
                    <div class="item-details">
                        <div class="detail-row">
                            <span>Entry: ‚Çπ{{ item.entry_price }}</span>
                            <span>Qty: {{ item.quantity }}</span>
                        </div>
                        <div class="detail-row">
                            <span>Invested: ‚Çπ{{ item.invested_amount }}</span>
                            {% if item.pnl_percentage %}
                            <span class="{% if item.pnl_percentage > 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ item.pnl_percentage }}%
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="empty-state">
                    <p>Your portfolio is empty</p>
                    <small>Add research calls to start tracking</small>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Top Brokers -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2>Top Performing Brokers</h2>
            </div>
            <div class="brokers-list">
                {% for broker in top_brokers %}
                <div class="broker-item">
                    <div class="broker-info">
                        <h4>{{ broker.name }}</h4>
                        <small>{{ broker.total_calls_published }} calls</small>
                    </div>
                    <div class="broker-accuracy">
                        <span class="accuracy-badge">{{ broker.overall_accuracy }}%</span>
                    </div>
                </div>
                {% empty %}
                <div class="empty-state">
                    <p>No broker data available</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
.dashboard-container {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.dashboard-header {
    margin-bottom: 2rem;
}

.dashboard-header h1 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-icon {
    font-size: 2.5rem;
}

.stat-content h3 {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0;
}

.stat-content p {
    margin: 0;
    color: var(--text-secondary);
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
}

.dashboard-section {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--border-color);
}

.section-header h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
}

.call-card {
    padding: 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 1rem;
}

.call-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
}

.call-header h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
}

.price-info {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1rem;
}

.price-item {
    display: flex;
    flex-direction: column;
}

.price-item label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.price-item span {
    font-weight: 600;
}

.call-actions {
    display: flex;
    gap: 0.5rem;
}

.portfolio-item, .broker-item {
    padding: 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 1rem;
}

.item-header, .broker-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
}

.accuracy-badge {
    background: var(--success-color);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-weight: 600;
}

.empty-state {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
}
</style>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function addToPortfolio(callId) {
        const csrftoken = getCookie('csrftoken');
        
        // Simple prompt for quantity (in a real app, use a modal)
        const quantity = prompt("Enter quantity:", "1");
        if (!quantity) return;
        
        const entryPrice = prompt("Enter entry price (leave empty for current market price):", "");

        const formData = new FormData();
        formData.append('call_id', callId);
        formData.append('quantity', quantity);
        if (entryPrice) formData.append('entry_price', entryPrice);

        fetch("{% url 'portfolios:add' %}", {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Success: ' + data.message);
                location.reload(); // Reload to update stats
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }

    function addToWatchlist(callId) {
        const csrftoken = getCookie('csrftoken');
        const formData = new FormData();
        formData.append('call_id', callId);

        fetch("{% url 'watchlists:add' %}", {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Success: ' + data.message);
            } else {
                alert('Info: ' + (data.message || data.error));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
</script>
{% endblock %}
